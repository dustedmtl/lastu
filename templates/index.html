<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LASTU Query App</title>
    <style>
        /* Basic reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Layout styling */
        body, html {
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            overflow-y: auto; /* Makes the table scrollable */
            flex-direction: column;
            flex: 1;
        }

        header, footer {
            padding: 10px;
            background: #f0f0f0;
            text-align: left;
            flex-shrink: 0; /* Prevent header and footer from shrinking */
        }

        /* Form styling */
        #queryForm {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* Table styling */
        .table-container {
            flex: 1;
            overflow-y: auto; /* Makes the table scrollable */
            padding: 0 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            cursor: pointer;
        }

        .spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        .loading {
            background-color: #e0e0e0;
            color: #a0a0a0;
        }

        .loading .spinner {
            display: block;
        }

        /* Spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Style for the header content */
        .header-content {
             display: flex;
             align-items: center;
             justify-content: space-between;
        }

        /* Space for the sort icon, even if empty */
        .sort-icon {
             font-size: 0.8em; /* Smaller than the header text */
             width: 1em;       /* Reserve space for icon */
             display: inline-block;
             text-align: center;
        }

        /* Ascending and descending classes for additional styling */
        .ascending .sort-icon {
             color: #4caf50; /* Example color for ascending */
        }

        .descending .sort-icon {
             color: #f44336; /* Example color for descending */
        }

    </style>
</head>
<body>
    <header>
        <h1>LASTU Query App</h1>
        <form id="queryForm">
            <label for="querytxt">Query:</label>
            <input type="text" id="querytxt" name="querytxt" size="40" required>
            <button type="submit">Submit</button>
        </form>
    </header>

    <div class="container">
        <div class="table-container">
            <div class="spinner"></div> <!-- Loading Spinner -->
            <table id="resultsTable">
                <thead id="tableHeader">
                    <!-- Headers will be dynamically inserted here -->
                </thead>
                <tbody id="tableBody">
                    <!-- Table rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        <div id="tableFooter" class="footer"></div>
    </footer>

    <script>
        const maxRows = 100;  // Control the maximum number of rows displayed
        let currentSortColumn = 'frequency';
        let currentSortDirection = false;  // true for ascending, false for descending
        let originalData = [];  // To hold the full dataset for sorting

        // References to important elements
        const queryForm = document.getElementById('queryForm');
        const queryInput = document.getElementById('querytxt');
        const submitButton = queryForm.querySelector('button');
        const tableContainer = document.querySelector('.table-container');
        const spinner = document.querySelector('.spinner');

        // Display loading state
        function setLoadingState(isLoading) {
            if (isLoading) {
                queryInput.disabled = true;
                submitButton.disabled = true;
                tableContainer.classList.add('loading');
                spinner.style.display = 'block';
            } else {
                queryInput.disabled = false;
                submitButton.disabled = false;
                tableContainer.classList.remove('loading');
                spinner.style.display = 'none';
            }
        }

        // Remember sorting state across queries
        async function fetchAndDisplayData(querytxt) {
            try {
                const response = await fetch('/query-polars', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ querytxt })
                });
                const result = await response.json();

                document.getElementById('tableFooter').textContent = result.message;

                if (result.data && result.data.length > 0) {
                    originalData = result.data;

                    // Apply saved sorting on new data if a sort column was selected
                    if (currentSortColumn !== null) {
                        sortTableByColumn(originalData, currentSortColumn, currentSortDirection);
                    } else {
                        generateTable(originalData);
                    }
                } else {
                    document.getElementById('tableBody').innerHTML = "<tr><td colspan='100%'>No data available</td></tr>";
                }
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('tableFooter').textContent = "Error fetching data.";
            } finally {
                setLoadingState(false); // Hide loading indicator
            }
        }

        // Generate table with top maxRows rows and sortable headers
        function generateTable(data) {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const tableFooter = document.getElementById('tableFooter');

            // Clear previous table contents
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            tableFooter.innerHTML = '';

            // Create table headers dynamically
            const headers = Object.keys(data[0]);
            const headerRow = document.createElement('tr');
            headers.forEach((header, index) => {
                const th = document.createElement('th');

                // Create a div to contain the header text and sort icon
                const headerDiv = document.createElement('div');
                headerDiv.classList.add('header-content');

                // Header text
                const headerText = document.createElement('span');
                headerText.textContent = header;
                headerDiv.appendChild(headerText);

                // Sort icon placeholder
                const sortIcon = document.createElement('span');
                sortIcon.classList.add('sort-icon');
                if (header === currentSortColumn) {
                    sortIcon.textContent = currentSortDirection ? '▲' : '▼'; // Up or down arrow
                } else {
                    sortIcon.innerHTML = '&nbsp;'; // Space reserved for icon
                }
                headerDiv.appendChild(sortIcon);

                th.appendChild(headerDiv);

                th.addEventListener('click', () => {
                    if (currentSortColumn === header) {
                        currentSortDirection = !currentSortDirection;
                    } else {
                        currentSortColumn = header;
                        // currentSortDirection = true;
                    }
                    sortTableByColumn(originalData, currentSortColumn, currentSortDirection);
                });
                headerRow.appendChild(th);
            });
            tableHeader.appendChild(headerRow);

            const limitedData = data.slice(0, maxRows);
            limitedData.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            tableFooter.textContent = data.length <= maxRows
                ? `Showing ${data.length} results`
                : `Showing ${maxRows} rows of ${data.length}`;

        }

        // Sort function modified to remember direction and column
        function sortTableByColumn(data, column, ascending) {
            data.sort((a, b) => {
                const valA = a[column];
                const valB = b[column];

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return ascending ? valA - valB : valB - valA;
                } else {
                    return ascending
                        ? String(valA).localeCompare(String(valB))
                        : String(valB).localeCompare(String(valA));
                }
            });

            // Remove all sort indicators before setting the new one
            document.querySelectorAll('th').forEach(th => th.classList.remove('ascending', 'descending'));

            // Update the sort indicator for the current column
            const headers = document.querySelectorAll("th");
            headers.forEach((header, index) => {
                if (header.textContent === column) {
                    header.classList.add(ascending ? "ascending" : "descending");
                }
            });

            generateTable(data);
        }

        // Form submission handler that sets the loading state and fetches data
        document.getElementById('queryForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const querytxt = document.getElementById('querytxt').value;

            setLoadingState(true); // Show loading indicator
            await fetchAndDisplayData(querytxt); // Fetch data with preserved sorting state
        });

    </script>
</body>
</html>
