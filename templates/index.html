<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LASTU Query App</title>
    <style>
        /* Basic reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Layout styling */
        body, html {
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            overflow-y: auto; /* Makes the table scrollable */
            flex-direction: column;
            flex: 1;
        }

        header, footer {
            padding: 10px;
            background: #f0f0f0;
            text-align: left;
            flex-shrink: 0; /* Prevent header and footer from shrinking */
        }

        /* Form styling */
        #queryForm {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* Table styling */
        .table-container {
            flex: 1;
            overflow-y: auto; /* Makes the table scrollable */
            padding: 0 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            cursor: pointer;
        }

        .ascending::after {
            content: " ▲";
        }

        .descending::after {
            content: " ▼";
        }

        .spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        .loading {
            background-color: #e0e0e0;
            color: #a0a0a0;
        }

        .loading .spinner {
            display: block;
        }

        /* Spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <h1>LASTU Query App</h1>
        <form id="queryForm">
            <label for="querytxt">Query:</label>
            <input type="text" id="querytxt" name="querytxt" size="40" required>
            <button type="submit">Submit</button>
        </form>
    </header>

    <div class="container">
        <div class="table-container">
            <div class="spinner"></div> <!-- Loading Spinner -->
            <table id="resultsTable">
                <thead id="tableHeader">
                    <!-- Headers will be dynamically inserted here -->
                </thead>
                <tbody id="tableBody">
                    <!-- Table rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        <div id="tableFooter" class="footer"></div>
    </footer>

    <script>
        const maxRows = 100;  // Control the maximum number of rows displayed
        let currentSortColumn = null;
        let currentSortDirection = true;  // true for ascending, false for descending
        let originalData = [];  // To hold the full dataset for sorting

        // References to important elements
        const queryForm = document.getElementById('queryForm');
        const queryInput = document.getElementById('querytxt');
        const submitButton = queryForm.querySelector('button');
        const tableContainer = document.querySelector('.table-container');
        const spinner = document.querySelector('.spinner');

        // Display loading state
        function setLoadingState(isLoading) {
            if (isLoading) {
                queryInput.disabled = true;
                submitButton.disabled = true;
                tableContainer.classList.add('loading');
                spinner.style.display = 'block';
            } else {
                queryInput.disabled = false;
                submitButton.disabled = false;
                tableContainer.classList.remove('loading');
                spinner.style.display = 'none';
            }
        }

        // Submit form and fetch data from API
        document.getElementById('queryForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const querytxt = document.getElementById('querytxt').value;

            setLoadingState(true); // Show loading indicator

            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ querytxt })
                });
                const result = await response.json();

                // Display the query message or status
                document.getElementById('tableFooter').textContent = result.message;

                // Populate table if data is available
                if (result.data && result.data.length > 0) {
                    originalData = result.data;  // Store original data for sorting
                    generateTable(originalData);
                } else {
                    document.getElementById('tableBody').innerHTML = "<tr><td colspan='100%'>No data available</td></tr>";
                }
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('tableFooter').textContent = "Error fetching data.";
            } finally {
                setLoadingState(false); // Hide loading indicator
            }
        });

        // Generate table with top maxRows rows and sortable headers
        function generateTable(data) {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const tableFooter = document.getElementById('tableFooter');

            // Clear previous table contents
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            tableFooter.innerHTML = '';

            // Create table headers dynamically
            const headers = Object.keys(data[0]);
            const headerRow = document.createElement('tr');
            headers.forEach((header, index) => {
                const th = document.createElement('th');
                th.textContent = header;
                th.addEventListener('click', () => sortTableByColumn(originalData, header, index));
                headerRow.appendChild(th);
            });
            tableHeader.appendChild(headerRow);

            // Display only the top 100 rows
            const top100Data = data.slice(0, maxRows);
            top100Data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            // Update footer text based on row count
            if (data.length <= maxRows) {
                tableFooter.textContent = `Showing ${data.length} results`;
            } else {
                tableFooter.textContent = `Showing ${maxRows} rows of ${data.length}`;
            }
        }

        // Sort the table by a specified column
        function sortTableByColumn(data, column, columnIndex) {
            // Determine sort direction
            if (currentSortColumn === columnIndex) {
                currentSortDirection = !currentSortDirection;  // Toggle direction
            } else {
                currentSortDirection = true;  // Default to ascending
                currentSortColumn = columnIndex;
            }

            // Sort the data array
            data.sort((a, b) => {
                const valA = a[column];
                const valB = b[column];

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return currentSortDirection ? valA - valB : valB - valA;
                } else {
                    return currentSortDirection
                        ? String(valA).localeCompare(String(valB))
                        : String(valB).localeCompare(String(valA));
                }
            });

            // Update the table with sorted data, displaying only the top maxRows rows
            generateTable(data);

            // Update sort indicator in headers
            const headers = document.querySelectorAll("th");
            headers.forEach((header, index) => {
                header.classList.remove("ascending", "descending");
                if (index === columnIndex) {
                    header.classList.add(currentSortDirection ? "ascending" : "descending");
                }
            });
        }
    </script>
</body>
</html>
